CREATE OR REPLACE PACKAGE BODY column_mgmt_pkg IS

  --------------------------------------------------------------------
  -- COLUMN ELJÁRÁSOK
  --------------------------------------------------------------------

  PROCEDURE create_column_prc(p_board_id    IN column_def.board_id%TYPE
                             ,p_column_name IN column_def.column_name%TYPE
                             ,p_wip_limit   IN column_def.wip_limit%TYPE
                             ,p_position    IN column_def.position%TYPE
                             ,p_status_code IN task_status.code%TYPE
                             ,p_column_id   OUT column_def.id%TYPE) IS
    l_status_id task_status.id%TYPE;
  BEGIN
    ------------------------------------------------------------------
    -- 1. Status ID kikeresése a code alapján
    ------------------------------------------------------------------
    SELECT id INTO l_status_id FROM task_status WHERE code = p_status_code;
  
    ------------------------------------------------------------------
    -- 2. Oszlop beszúrása
    ------------------------------------------------------------------
    INSERT INTO column_def
      (board_id
      ,column_name
      ,wip_limit
      ,position
      ,status_id)
    VALUES
      (p_board_id
      ,p_column_name
      ,p_wip_limit
      ,p_position
      ,l_status_id)
    RETURNING id INTO p_column_id;
  
  EXCEPTION
    WHEN no_data_found THEN
      -- Nincs ilyen task_status code
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'create_column_prc',
                            p_error_code     => -20080,
                            p_error_msg      => 'Nincs ilyen task_status code: "' ||
                                                p_status_code || '".',
                            p_context        => 'board_id=' || p_board_id ||
                                                '; column_name="' ||
                                                p_column_name || '"' ||
                                                '; status_code="' ||
                                                p_status_code || '"',
                            p_api            => NULL);
      RAISE pkg_exceptions.create_column_status_not_found;
    
    WHEN dup_val_on_index THEN
      -- (board_id, column_name) vagy (board_id, position) unique constraint sérül
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'create_column_prc',
                            p_error_code     => -20081,
                            p_error_msg      => 'Ütközés a column_def egyediségén (név vagy pozíció boardon belül).',
                            p_context        => 'board_id=' || p_board_id ||
                                                '; column_name="' ||
                                                p_column_name || '"' ||
                                                '; position=' || p_position,
                            p_api            => NULL);
      RAISE pkg_exceptions.create_column_dup;
    
    WHEN OTHERS THEN
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'create_column_prc',
                            p_error_code     => SQLCODE,
                            p_error_msg      => SQLERRM,
                            p_context        => 'board_id=' || p_board_id ||
                                                '; column_name="' ||
                                                p_column_name || '"' ||
                                                '; position=' || p_position ||
                                                '; status_code="' ||
                                                p_status_code || '"',
                            p_api            => NULL);
      RAISE pkg_exceptions.create_column_generic;
  END create_column_prc;

  ------------------------------------------------------------------------------------------------------------------------------------

  PROCEDURE update_column_prc(p_column_id     IN column_def.id%TYPE
                             ,p_new_name      IN column_def.column_name%TYPE
                             ,p_new_wip_limit IN column_def.wip_limit%TYPE) IS
  BEGIN
    UPDATE column_def
       SET column_name = p_new_name
          ,wip_limit   = p_new_wip_limit
     WHERE id = p_column_id;
  
    IF SQL%ROWCOUNT = 0
    THEN
      -- Nincs ilyen oszlop
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'update_column_prc',
                            p_error_code     => -20150,
                            p_error_msg      => 'Nem található a megadott column.',
                            p_context        => 'column_id=' || p_column_id ||
                                                '; new_name="' || p_new_name || '"' ||
                                                '; new_wip_limit=' ||
                                                p_new_wip_limit,
                            p_api            => NULL);
      RAISE pkg_exceptions.update_column_not_found;
    END IF;
  
  EXCEPTION
    WHEN dup_val_on_index THEN
      -- (board_id, column_name) vagy (board_id, position) unique megsértése
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'update_column_prc',
                            p_error_code     => -20151,
                            p_error_msg      => 'Ütközés a column egyedi constraintjeivel (név vagy pozíció).',
                            p_context        => 'column_id=' || p_column_id ||
                                                '; new_name="' || p_new_name || '"' ||
                                                '; new_wip_limit=' ||
                                                p_new_wip_limit,
                            p_api            => NULL);
      RAISE pkg_exceptions.update_column_duplicate;
    
    WHEN OTHERS THEN
      err_log_pkg.log_error(p_module_name    => 'COLUMN',
                            p_procedure_name => 'update_column_prc',
                            p_error_code     => SQLCODE,
                            p_error_msg      => SQLERRM,
                            p_context        => 'column_id=' || p_column_id ||
                                                '; new_name="' || p_new_name || '"' ||
                                                '; new_wip_limit=' ||
                                                p_new_wip_limit,
                            p_api            => NULL);
      RAISE pkg_exceptions.update_column_generic;
  END update_column_prc;

  ------------------------------------------------------------------------------------------------------------------------------------
  
  --------------------------------------------------------------------
  -- OSZLOP SORRENDEZÉS BIZTONSÁGOSAN (ÚJRASZÁMOZÁS + IDEIGLENES ELTOLÁS)
  --------------------------------------------------------------------
  PROCEDURE reorder_column_prc(p_column_id    IN column_def.id%TYPE
                              ,p_new_position IN column_def.position%TYPE) IS
    TYPE t_col_id_tab IS TABLE OF column_def.id%TYPE INDEX BY PLS_INTEGER;

    l_all_ids    t_col_id_tab;  -- jelenlegi sorrend
    l_new_ids    t_col_id_tab;  -- új sorrend
    l_board_id   column_def.board_id%TYPE;
    l_old_pos    column_def.position%TYPE;
    l_cnt        PLS_INTEGER := 0;
    l_idx        PLS_INTEGER;
    l_target_pos PLS_INTEGER;
    l_placed     BOOLEAN := FALSE;
  BEGIN
    IF p_new_position < 1 THEN
      raise_application_error(-20160,
        'reorder_column_prc: a pozíció nem lehet 1-nél kisebb.');
    END IF;

    ------------------------------------------------------------------
    -- 1. A rendezendő oszlop boardja és aktuális pozíciója
    ------------------------------------------------------------------
    SELECT board_id, position
      INTO l_board_id, l_old_pos
      FROM column_def
     WHERE id = p_column_id;

    IF p_new_position = l_old_pos THEN
      RETURN;
    END IF;

    ------------------------------------------------------------------
    -- 2. Oszlopok beolvasása az adott boardról, pozíció szerint
    ------------------------------------------------------------------
    FOR r IN (SELECT id
                FROM column_def
               WHERE board_id = l_board_id
               ORDER BY position)
    LOOP
      l_cnt := l_cnt + 1;
      l_all_ids(l_cnt) := r.id;
    END LOOP;

    IF l_cnt = 0 THEN
      raise_application_error(-20162,
        'reorder_column_prc: nem találtam oszlopokat a boardon (board_id=' ||
        l_board_id || ').');
    END IF;

    ------------------------------------------------------------------
    -- 3. Cél pozíció normalizálása (ha nagyobb, mint elemszám → lista vége)
    ------------------------------------------------------------------
    l_target_pos := p_new_position;
    IF l_target_pos > l_cnt THEN
      l_target_pos := l_cnt;
    END IF;

    ------------------------------------------------------------------
    -- 4. Új sorrend felépítése memóriában
    ------------------------------------------------------------------
    l_idx := 1;

    FOR i IN 1 .. l_cnt LOOP
      -- Mozgatott oszlopot kihagyjuk az eredeti sorrendből
      IF l_all_ids(i) = p_column_id THEN
        CONTINUE;
      END IF;

      -- Ha a célpozícióhoz értünk, előbb a mozgatott oszlop megy
      IF l_idx = l_target_pos THEN
        l_new_ids(l_idx) := p_column_id;
        l_idx    := l_idx + 1;
        l_placed := TRUE;
      END IF;

      -- Majd az aktuális oszlop
      l_new_ids(l_idx) := l_all_ids(i);
      l_idx := l_idx + 1;
    END LOOP;

    -- Ha még nem lett berakva (pl. cél pozíció a legvégén volt)
    IF NOT l_placed THEN
      l_new_ids(l_idx) := p_column_id;
      l_idx := l_idx + 1;
    END IF;

    ------------------------------------------------------------------
    -- 5. IDEIGLENES ELTOLÁS: minden oszlop position +1000
    --    (így azonnal megszűnik a 1..N tartományban minden ütközés)
    ------------------------------------------------------------------
    UPDATE column_def
       SET position = position + 1000
     WHERE board_id = l_board_id;

    ------------------------------------------------------------------
    -- 6. Végleges 1..N pozíciók visszaírása – itt már nem tud ütközni
    ------------------------------------------------------------------
    FOR i IN 1 .. l_idx - 1 LOOP
      UPDATE column_def
         SET position = i
       WHERE id = l_new_ids(i);
    END LOOP;

  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      raise_application_error(-20163,
        'reorder_column_prc: a megadott column_id nem található: ' ||
        p_column_id);

    WHEN OTHERS THEN
      raise_application_error(-20161,
        'reorder_column_prc hiba (column_id=' || p_column_id ||
        ', new_position=' || p_new_position || '): ' || SQLERRM);
  END reorder_column_prc;


END column_mgmt_pkg;
/
